<!doctype html>
<html lang="es">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Gesti√≥n de Usuarios y Permisos</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #e8f5e9 0%, #ffffff 100%);
      min-height: 100%;
      height: 100%;
    }
    
    html {
      height: 100%;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }
    
    .header {
      background: linear-gradient(135deg, #2e7d32 0%, #43a047 100%);
      color: white;
      padding: 32px;
      border-radius: 16px;
      margin-bottom: 24px;
      box-shadow: 0 4px 12px rgba(46, 125, 50, 0.2);
    }
    
    .header h1 {
      margin: 0 0 8px 0;
      font-size: 32px;
      font-weight: 600;
    }
    
    .header p {
      margin: 0;
      font-size: 16px;
      opacity: 0.95;
    }
    
    .controls-section {
      background: white;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .control-group {
      display: flex;
      flex-direction: column;
    }
    
    .control-group label {
      font-size: 14px;
      font-weight: 600;
      color: #2e7d32;
      margin-bottom: 6px;
    }
    
    .control-group select,
    .control-group input {
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .control-group select:focus,
    .control-group input:focus {
      outline: none;
      border-color: #43a047;
      box-shadow: 0 0 0 3px rgba(67, 160, 71, 0.1);
    }
    
    .button-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: #2e7d32;
      color: white;
    }
    
    .btn-primary:hover {
      background: #1b5e20;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
    }
    
    .btn-secondary {
      background: white;
      color: #2e7d32;
      border: 2px solid #2e7d32;
    }
    
    .btn-secondary:hover {
      background: #f1f8e9;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      border-left: 4px solid #43a047;
    }
    
    .stat-card h3 {
      margin: 0 0 8px 0;
      font-size: 14px;
      color: #666;
      font-weight: 500;
    }
    
    .stat-card p {
      margin: 0;
      font-size: 32px;
      font-weight: 700;
      color: #2e7d32;
    }
    
    .table-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }
    
    .table-header {
      padding: 20px 24px;
      background: #f1f8e9;
      border-bottom: 2px solid #c5e1a5;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .table-header h2 {
      margin: 0;
      font-size: 20px;
      color: #2e7d32;
    }
    
    .table-wrapper {
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    thead {
      background: #2e7d32;
      color: white;
    }
    
    th {
      padding: 16px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
    }
    
    td {
      padding: 16px;
      border-bottom: 1px solid #e0e0e0;
      font-size: 14px;
    }
    
    tbody tr:hover {
      background: #f1f8e9;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .badge-individual {
      background: #e3f2fd;
      color: #1565c0;
    }
    
    .badge-grupal {
      background: #f3e5f5;
      color: #6a1b9a;
    }
    
    .badge-academica {
      background: #fff3e0;
      color: #e65100;
    }
    
    .badge-completada {
      background: #c8e6c9;
      color: #2e7d32;
    }
    
    .badge-pendiente {
      background: #fff9c4;
      color: #f57f17;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }
    
    .empty-state svg {
      width: 80px;
      height: 80px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
      color: #2e7d32;
    }
    
    .loading.active {
      display: block;
    }
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal {
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      max-width: 600px;
      width: 90%;
      max-height: 90%;
      overflow-y: auto;
    }
    
    .modal-small {
      max-width: 400px;
    }
    
    .modal-header {
      padding: 24px 24px 0 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h3 {
      margin: 0;
      color: #2e7d32;
      font-size: 20px;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s ease;
    }
    
    .modal-close:hover {
      background: #f5f5f5;
      color: #333;
    }
    
    .modal-body {
      padding: 24px;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .form-group label {
      font-size: 14px;
      font-weight: 600;
      color: #2e7d32;
      margin-bottom: 6px;
    }
    
    .form-group input,
    .form-group select {
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #43a047;
      box-shadow: 0 0 0 3px rgba(67, 160, 71, 0.1);
    }
    
    .permissions-section {
      margin-bottom: 24px;
    }
    
    .permissions-section h4 {
      margin: 0 0 16px 0;
      color: #2e7d32;
      font-size: 16px;
    }
    
    .permissions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }
    
    .permission-item {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: background 0.3s ease;
    }
    
    .permission-item:hover {
      background: #f1f8e9;
    }
    
    .permission-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #43a047;
    }
    
    .permission-item span {
      font-size: 14px;
      color: #333;
    }
    
    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
    }
    
    .action-buttons {
      display: flex;
      gap: 8px;
    }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 6px;
    }
    
    .btn-danger {
      background: #d32f2f;
      color: white;
    }
    
    .btn-danger:hover {
      background: #b71c1c;
    }
    
    .btn-warning {
      background: #f57c00;
      color: white;
    }
    
    .btn-warning:hover {
      background: #e65100;
    }
    
    .badge-activo {
      background: #c8e6c9;
      color: #2e7d32;
    }
    
    .badge-inactivo {
      background: #ffcdd2;
      color: #d32f2f;
    }
    
    .badge-suspendido {
      background: #fff9c4;
      color: #f57f17;
    }
    
    .badge-administrador {
      background: #e1f5fe;
      color: #0277bd;
    }
    
    .badge-coordinador {
      background: #f3e5f5;
      color: #7b1fa2;
    }
    
    .badge-tutor {
      background: #fff3e0;
      color: #ef6c00;
    }
    
    .badge-asistente {
      background: #e8f5e9;
      color: #388e3c;
    }
    
    .permissions-display {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    
    .permission-badge {
      background: #e3f2fd;
      color: #1565c0;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }
    
    @media (max-width: 768px) {
      .controls-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .button-group {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
        justify-content: center;
      }
      
      .table-wrapper {
        overflow-x: scroll;
      }
      
      table {
        min-width: 1000px;
      }
      
      .modal {
        width: 95%;
        margin: 20px;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .permissions-grid {
        grid-template-columns: 1fr;
      }
      
      .modal-actions {
        flex-direction: column;
      }
      
      .action-buttons {
        flex-direction: column;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="container">
   <div class="header">
    <h1 id="system-title">Sistema de Gesti√≥n de Usuarios y Permisos</h1>
    <p id="institution-name">Escuela Profesional de Ingenier√≠a Inform√°tica y de Sistemas</p>
   </div>
   <div class="controls-section">
    <div class="controls-grid">
     <div class="control-group"><label for="filter-rol">Rol</label> <select id="filter-rol"> <option value="">Todos los roles</option> <option value="Administrador">Administrador del Sistema</option> <option value="Director">Director de Escuela</option> <option value="Coordinador">Coordinador Acad√©mico</option> <option value="Docente">Docente</option> <option value="Tutor">Tutor Acad√©mico</option> <option value="Asistente">Asistente Administrativo</option> </select>
     </div>
     <div class="control-group"><label for="filter-departamento">√Årea</label> <select id="filter-departamento"> <option value="">Todas las √°reas</option> <option value="Desarrollo de Software">Desarrollo de Software</option> <option value="Redes y Telecomunicaciones">Redes y Telecomunicaciones</option> <option value="Base de Datos">Base de Datos</option> <option value="Inteligencia Artificial">Inteligencia Artificial</option> <option value="Ciberseguridad">Ciberseguridad</option> <option value="Administraci√≥n Acad√©mica">Administraci√≥n Acad√©mica</option> </select>
     </div>
     <div class="control-group"><label for="filter-estado">Estado</label> <select id="filter-estado"> <option value="">Todos los estados</option> <option value="Activo">Activo</option> <option value="Inactivo">Inactivo</option> <option value="Suspendido">Suspendido</option> </select>
     </div>
     <div class="control-group"><label for="search-usuario">Buscar Usuario</label> <input type="text" id="search-usuario" placeholder="Nombre o email...">
     </div>
    </div>
    <div class="button-group"><button class="btn btn-primary" id="btn-crear-usuario"> <span>üë§</span> <span id="create-user-button">Crear Nuevo Usuario</span> </button> <button class="btn btn-secondary" id="btn-aplicar-filtros"> <span>üîç</span> Aplicar Filtros </button> <button class="btn btn-secondary" id="btn-limpiar-filtros"> <span>üîÑ</span> Limpiar Filtros </button>
    </div>
   </div>
   <div class="stats-grid">
    <div class="stat-card">
     <h3>Total de Usuarios</h3>
     <p id="stat-total">0</p>
    </div>
    <div class="stat-card">
     <h3>Usuarios Activos</h3>
     <p id="stat-activos">0</p>
    </div>
    <div class="stat-card">
     <h3>Usuarios Inactivos</h3>
     <p id="stat-inactivos">0</p>
    </div>
    <div class="stat-card">
     <h3>Administradores</h3>
     <p id="stat-administradores">0</p>
    </div>
   </div>
   <div class="table-container">
    <div class="table-header">
     <h2 id="permissions-title">Gesti√≥n de Usuarios y Permisos</h2>
    </div>
    <div class="loading" id="loading">
     <p>‚è≥ Cargando usuarios...</p>
    </div>
    <div class="table-wrapper" id="table-wrapper">
     <table id="usuario-table">
      <thead>
       <tr>
        <th>Usuario</th>
        <th>Email Institucional</th>
        <th>Rol</th>
        <th>√Årea de Especializaci√≥n</th>
        <th>Estado</th>
        <th>Permisos Asignados</th>
        <th>√öltimo Acceso</th>
        <th>Acciones</th>
       </tr>
      </thead>
      <tbody id="usuario-tbody">
      </tbody>
     </table>
    </div>
    <div class="empty-state" id="empty-state" style="display: none;">
     <svg viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
     </svg>
     <h3>No hay usuarios registrados</h3>
     <p>Comienza creando usuarios para gestionar los permisos del sistema.</p>
    </div>
   </div><!-- Modal para crear/editar usuario -->
   <div class="modal-overlay" id="modal-overlay" style="display: none;">
    <div class="modal">
     <div class="modal-header">
      <h3 id="modal-title">Crear Nuevo Usuario</h3><button class="modal-close" id="modal-close">√ó</button>
     </div>
     <form class="modal-body" id="user-form">
      <div class="form-grid">
       <div class="form-group"><label for="user-nombre">Nombre Completo *</label> <input type="text" id="user-nombre" required>
       </div>
       <div class="form-group"><label for="user-email">Email *</label> <input type="email" id="user-email" required>
       </div>
       <div class="form-group"><label for="user-rol">Rol *</label> <select id="user-rol" required> <option value="">Seleccionar rol</option> <option value="Administrador">Administrador del Sistema</option> <option value="Director">Director de Escuela</option> <option value="Coordinador">Coordinador Acad√©mico</option> <option value="Docente">Docente</option> <option value="Tutor">Tutor Acad√©mico</option> <option value="Asistente">Asistente Administrativo</option> </select>
       </div>
       <div class="form-group"><label for="user-area">√Årea de Especializaci√≥n *</label> <select id="user-departamento" required> <option value="">Seleccionar √°rea</option> <option value="Desarrollo de Software">Desarrollo de Software</option> <option value="Redes y Telecomunicaciones">Redes y Telecomunicaciones</option> <option value="Base de Datos">Base de Datos</option> <option value="Inteligencia Artificial">Inteligencia Artificial</option> <option value="Ciberseguridad">Ciberseguridad</option> <option value="Administraci√≥n Acad√©mica">Administraci√≥n Acad√©mica</option> </select>
       </div>
      </div>
      <div class="permissions-section">
       <h4>Permisos del Sistema de Ingenier√≠a</h4>
       <div class="permissions-grid"><label class="permission-item"> <input type="checkbox" id="perm-tutoria"> <span>Gesti√≥n de Tutor√≠as Acad√©micas</span> </label> <label class="permission-item"> <input type="checkbox" id="perm-reportes"> <span>Reportes y Estad√≠sticas</span> </label> <label class="permission-item"> <input type="checkbox" id="perm-usuarios"> <span>Administraci√≥n de Usuarios</span> </label> <label class="permission-item"> <input type="checkbox" id="perm-estudiantes"> <span>Gesti√≥n de Estudiantes</span> </label> <label class="permission-item"> <input type="checkbox" id="perm-cursos"> <span>Gesti√≥n de Cursos</span> </label> <label class="permission-item"> <input type="checkbox" id="perm-configuracion"> <span>Configuraci√≥n del Sistema</span> </label>
       </div>
      </div>
      <div class="modal-actions"><button type="button" class="btn btn-secondary" id="btn-cancelar">Cancelar</button> <button type="submit" class="btn btn-primary" id="btn-guardar">Guardar Usuario</button>
      </div>
     </form>
    </div>
   </div><!-- Modal de confirmaci√≥n -->
   <div class="modal-overlay" id="confirm-modal" style="display: none;">
    <div class="modal modal-small">
     <div class="modal-header">
      <h3>Confirmar Acci√≥n</h3>
     </div>
     <div class="modal-body">
      <p id="confirm-message">¬øEst√° seguro de realizar esta acci√≥n?</p>
      <div class="modal-actions"><button type="button" class="btn btn-secondary" id="btn-cancelar-confirm">Cancelar</button> <button type="button" class="btn btn-primary" id="btn-confirmar">Confirmar</button>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      background_color: "#e8f5e9",
      primary_color: "#2e7d32",
      secondary_color: "#43a047",
      text_color: "#333333",
      surface_color: "#ffffff",
      font_family: "Segoe UI",
      font_size: 16,
      system_title: "Sistema de Gesti√≥n de Usuarios y Permisos",
      institution_name: "Escuela Profesional de Ingenier√≠a Inform√°tica y de Sistemas",
      create_user_button: "Crear Nuevo Usuario",
      permissions_title: "Gesti√≥n de Usuarios y Permisos"
    };

    let allUsuarios = [];
    let filteredUsuarios = [];
    let editingUser = null;
    let pendingAction = null;

    const dataHandler = {
      onDataChanged(data) {
        allUsuarios = data;
        applyFilters();
      }
    };

    async function initializeApp() {
      const initResult = await window.dataSdk.init(dataHandler);
      if (!initResult.isOk) {
        console.error("Error al inicializar Data SDK");
      }
      
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => {
            const customFont = config.font_family || defaultConfig.font_family;
            const baseFontStack = 'Tahoma, Geneva, Verdana, sans-serif';
            const baseSize = config.font_size || defaultConfig.font_size;
            
            document.body.style.fontFamily = `${customFont}, ${baseFontStack}`;
            document.body.style.background = `linear-gradient(135deg, ${config.background_color || defaultConfig.background_color} 0%, ${config.surface_color || defaultConfig.surface_color} 100%)`;
            
            const header = document.querySelector('.header');
            if (header) {
              header.style.background = `linear-gradient(135deg, ${config.primary_color || defaultConfig.primary_color} 0%, ${config.secondary_color || defaultConfig.secondary_color} 100%)`;
            }
            
            const systemTitle = document.getElementById('system-title');
            if (systemTitle) {
              systemTitle.textContent = config.system_title || defaultConfig.system_title;
              systemTitle.style.fontSize = `${baseSize * 2}px`;
            }
            
            const institutionName = document.getElementById('institution-name');
            if (institutionName) {
              institutionName.textContent = config.institution_name || defaultConfig.institution_name;
              institutionName.style.fontSize = `${baseSize}px`;
            }
            
            const createUserButton = document.getElementById('create-user-button');
            if (createUserButton) {
              createUserButton.textContent = config.create_user_button || defaultConfig.create_user_button;
            }
            
            const permissionsTitle = document.getElementById('permissions-title');
            if (permissionsTitle) {
              permissionsTitle.textContent = config.permissions_title || defaultConfig.permissions_title;
              permissionsTitle.style.fontSize = `${baseSize * 1.25}px`;
            }
            
            const labels = document.querySelectorAll('.control-group label, .stat-card h3, th, .form-group label');
            labels.forEach(label => {
              label.style.color = config.primary_color || defaultConfig.primary_color;
              label.style.fontSize = `${baseSize * 0.875}px`;
            });
            
            const primaryButtons = document.querySelectorAll('.btn-primary');
            primaryButtons.forEach(btn => {
              btn.style.background = config.primary_color || defaultConfig.primary_color;
              btn.style.fontSize = `${baseSize * 0.875}px`;
            });
            
            const secondaryButtons = document.querySelectorAll('.btn-secondary');
            secondaryButtons.forEach(btn => {
              btn.style.color = config.primary_color || defaultConfig.primary_color;
              btn.style.borderColor = config.primary_color || defaultConfig.primary_color;
              btn.style.fontSize = `${baseSize * 0.875}px`;
            });
            
            const statValues = document.querySelectorAll('.stat-card p');
            statValues.forEach(val => {
              val.style.color = config.primary_color || defaultConfig.primary_color;
              val.style.fontSize = `${baseSize * 2}px`;
            });
            
            const tableHeader = document.querySelector('.table-header h2');
            if (tableHeader) {
              tableHeader.style.color = config.primary_color || defaultConfig.primary_color;
              tableHeader.style.fontSize = `${baseSize * 1.25}px`;
            }
            
            const thead = document.querySelector('thead');
            if (thead) {
              thead.style.background = config.primary_color || defaultConfig.primary_color;
            }
            
            const tableCells = document.querySelectorAll('td');
            tableCells.forEach(cell => {
              cell.style.fontSize = `${baseSize * 0.875}px`;
            });
          },
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => config.background_color || defaultConfig.background_color,
                set: (value) => {
                  config.background_color = value;
                  window.elementSdk.setConfig({ background_color: value });
                }
              },
              {
                get: () => config.surface_color || defaultConfig.surface_color,
                set: (value) => {
                  config.surface_color = value;
                  window.elementSdk.setConfig({ surface_color: value });
                }
              },
              {
                get: () => config.text_color || defaultConfig.text_color,
                set: (value) => {
                  config.text_color = value;
                  window.elementSdk.setConfig({ text_color: value });
                }
              },
              {
                get: () => config.primary_color || defaultConfig.primary_color,
                set: (value) => {
                  config.primary_color = value;
                  window.elementSdk.setConfig({ primary_color: value });
                }
              },
              {
                get: () => config.secondary_color || defaultConfig.secondary_color,
                set: (value) => {
                  config.secondary_color = value;
                  window.elementSdk.setConfig({ secondary_color: value });
                }
              }
            ],
            borderables: [],
            fontEditable: {
              get: () => config.font_family || defaultConfig.font_family,
              set: (value) => {
                config.font_family = value;
                window.elementSdk.setConfig({ font_family: value });
              }
            },
            fontSizeable: {
              get: () => config.font_size || defaultConfig.font_size,
              set: (value) => {
                config.font_size = value;
                window.elementSdk.setConfig({ font_size: value });
              }
            }
          }),
          mapToEditPanelValues: (config) => new Map([
            ["system_title", config.system_title || defaultConfig.system_title],
            ["institution_name", config.institution_name || defaultConfig.institution_name],
            ["create_user_button", config.create_user_button || defaultConfig.create_user_button],
            ["permissions_title", config.permissions_title || defaultConfig.permissions_title]
          ])
        });
      }
      
      setupEventListeners();
    }

    function setupEventListeners() {
      document.getElementById('btn-crear-usuario').addEventListener('click', () => openUserModal());
      document.getElementById('btn-aplicar-filtros').addEventListener('click', applyFilters);
      document.getElementById('btn-limpiar-filtros').addEventListener('click', clearFilters);
      document.getElementById('search-usuario').addEventListener('input', applyFilters);
      
      document.getElementById('modal-close').addEventListener('click', closeModal);
      document.getElementById('btn-cancelar').addEventListener('click', closeModal);
      document.getElementById('user-form').addEventListener('submit', handleUserSubmit);
      
      document.getElementById('btn-cancelar-confirm').addEventListener('click', closeConfirmModal);
      document.getElementById('btn-confirmar').addEventListener('click', executeAction);
      
      document.getElementById('modal-overlay').addEventListener('click', (e) => {
        if (e.target === document.getElementById('modal-overlay')) {
          closeModal();
        }
      });
    }

    function applyFilters() {
      const rol = document.getElementById('filter-rol').value;
      const departamento = document.getElementById('filter-departamento').value;
      const estado = document.getElementById('filter-estado').value;
      const search = document.getElementById('search-usuario').value.toLowerCase();
      
      filteredUsuarios = allUsuarios.filter(usuario => {
        if (rol && usuario.rol !== rol) return false;
        if (departamento && usuario.departamento !== departamento) return false;
        if (estado && usuario.estado !== estado) return false;
        if (search && !usuario.nombre_completo.toLowerCase().includes(search) && 
            !usuario.email.toLowerCase().includes(search)) return false;
        return true;
      });
      
      renderTable();
      updateStats();
    }

    function clearFilters() {
      document.getElementById('filter-rol').value = '';
      document.getElementById('filter-departamento').value = '';
      document.getElementById('filter-estado').value = '';
      document.getElementById('search-usuario').value = '';
      applyFilters();
    }

    function renderTable() {
      const tbody = document.getElementById('usuario-tbody');
      const emptyState = document.getElementById('empty-state');
      const tableWrapper = document.getElementById('table-wrapper');
      
      if (filteredUsuarios.length === 0) {
        tableWrapper.style.display = 'none';
        emptyState.style.display = 'block';
        return;
      }
      
      tableWrapper.style.display = 'block';
      emptyState.style.display = 'none';
      
      tbody.innerHTML = filteredUsuarios.map(usuario => {
        const permisos = getPermissionsBadges(usuario);
        const ultimoAcceso = usuario.ultimo_acceso ? 
          new Date(usuario.ultimo_acceso).toLocaleDateString('es-ES') : 'Nunca';
        
        return `
          <tr>
            <td>
              <div>
                <strong>${usuario.nombre_completo}</strong>
                ${usuario.password_temporal ? '<span class="permission-badge" style="background: #fff3e0; color: #e65100;">Contrase√±a temporal</span>' : ''}
              </div>
            </td>
            <td>${usuario.email}</td>
            <td><span class="badge badge-${usuario.rol.toLowerCase()}">${usuario.rol}</span></td>
            <td>${usuario.departamento}</td>
            <td><span class="badge badge-${usuario.estado.toLowerCase()}">${usuario.estado}</span></td>
            <td>
              <div class="permissions-display">
                ${permisos}
              </div>
            </td>
            <td>${ultimoAcceso}</td>
            <td>
              <div class="action-buttons">
                <button class="btn btn-small btn-secondary" onclick="editUser('${usuario.__backendId}')">
                  ‚úèÔ∏è Editar
                </button>
                <button class="btn btn-small btn-warning" onclick="toggleUserStatus('${usuario.__backendId}')">
                  ${usuario.estado === 'Activo' ? '‚è∏Ô∏è Suspender' : '‚ñ∂Ô∏è Activar'}
                </button>
                <button class="btn btn-small btn-danger" onclick="deleteUser('${usuario.__backendId}')">
                  üóëÔ∏è Eliminar
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function getPermissionsBadges(usuario) {
      const permisos = [];
      if (usuario.permisos_tutoria) permisos.push('Tutor√≠as');
      if (usuario.permisos_reportes) permisos.push('Reportes');
      if (usuario.permisos_usuarios) permisos.push('Usuarios');
      if (usuario.permisos_estudiantes) permisos.push('Estudiantes');
      if (usuario.permisos_cursos) permisos.push('Cursos');
      if (usuario.permisos_configuracion) permisos.push('Config');
      
      return permisos.map(p => `<span class="permission-badge">${p}</span>`).join('');
    }

    function updateStats() {
      const total = filteredUsuarios.length;
      const activos = filteredUsuarios.filter(u => u.estado === 'Activo').length;
      const inactivos = filteredUsuarios.filter(u => u.estado === 'Inactivo').length;
      const administradores = filteredUsuarios.filter(u => u.rol === 'Administrador').length;
      
      document.getElementById('stat-total').textContent = total;
      document.getElementById('stat-activos').textContent = activos;
      document.getElementById('stat-inactivos').textContent = inactivos;
      document.getElementById('stat-administradores').textContent = administradores;
    }

    function openUserModal(usuario = null) {
      editingUser = usuario;
      const modal = document.getElementById('modal-overlay');
      const title = document.getElementById('modal-title');
      const form = document.getElementById('user-form');
      
      if (usuario) {
        title.textContent = 'Editar Usuario';
        fillForm(usuario);
      } else {
        title.textContent = 'Crear Nuevo Usuario';
        form.reset();
      }
      
      modal.style.display = 'flex';
    }

    function fillForm(usuario) {
      document.getElementById('user-nombre').value = usuario.nombre_completo;
      document.getElementById('user-email').value = usuario.email;
      document.getElementById('user-rol').value = usuario.rol;
      document.getElementById('user-departamento').value = usuario.departamento;
      document.getElementById('perm-tutoria').checked = usuario.permisos_tutoria;
      document.getElementById('perm-reportes').checked = usuario.permisos_reportes;
      document.getElementById('perm-usuarios').checked = usuario.permisos_usuarios;
      document.getElementById('perm-estudiantes').checked = usuario.permisos_estudiantes;
      document.getElementById('perm-cursos').checked = usuario.permisos_cursos;
      document.getElementById('perm-configuracion').checked = usuario.permisos_configuracion;
    }

    function closeModal() {
      document.getElementById('modal-overlay').style.display = 'none';
      editingUser = null;
    }

    async function handleUserSubmit(e) {
      e.preventDefault();
      
      if (allUsuarios.length >= 999 && !editingUser) {
        showMessage('L√≠mite m√°ximo de 999 usuarios alcanzado. Elimine algunos usuarios primero.');
        return;
      }
      
      const userData = {
        nombre_completo: document.getElementById('user-nombre').value,
        email: document.getElementById('user-email').value,
        rol: document.getElementById('user-rol').value,
        departamento: document.getElementById('user-departamento').value,
        permisos_tutoria: document.getElementById('perm-tutoria').checked,
        permisos_reportes: document.getElementById('perm-reportes').checked,
        permisos_usuarios: document.getElementById('perm-usuarios').checked,
        permisos_estudiantes: document.getElementById('perm-estudiantes').checked,
        permisos_cursos: document.getElementById('perm-cursos').checked,
        permisos_configuracion: document.getElementById('perm-configuracion').checked,
        estado: editingUser ? editingUser.estado : 'Activo',
        fecha_creacion: editingUser ? editingUser.fecha_creacion : new Date().toISOString(),
        ultimo_acceso: editingUser ? editingUser.ultimo_acceso : null,
        password_temporal: editingUser ? editingUser.password_temporal : true,
        id: editingUser ? editingUser.id : `user_${Date.now()}`
      };
      
      showLoading(true);
      
      try {
        let result;
        if (editingUser) {
          result = await window.dataSdk.update({ ...userData, __backendId: editingUser.__backendId });
        } else {
          result = await window.dataSdk.create(userData);
        }
        
        if (result.isOk) {
          closeModal();
          showMessage(editingUser ? 'Usuario actualizado correctamente' : 'Usuario creado correctamente. Se ha generado una contrase√±a temporal.');
        } else {
          showMessage('Error al guardar el usuario. Int√©ntelo nuevamente.');
        }
      } catch (error) {
        showMessage('Error al procesar la solicitud.');
      } finally {
        showLoading(false);
      }
    }

    function editUser(userId) {
      const usuario = allUsuarios.find(u => u.__backendId === userId);
      if (usuario) {
        openUserModal(usuario);
      }
    }

    function toggleUserStatus(userId) {
      const usuario = allUsuarios.find(u => u.__backendId === userId);
      if (usuario) {
        const newStatus = usuario.estado === 'Activo' ? 'Suspendido' : 'Activo';
        const action = newStatus === 'Activo' ? 'activar' : 'suspender';
        
        showConfirmModal(
          `¬øEst√° seguro de ${action} al usuario ${usuario.nombre_completo}?`,
          async () => {
            showLoading(true);
            const result = await window.dataSdk.update({
              ...usuario,
              estado: newStatus,
              ultimo_acceso: newStatus === 'Activo' ? new Date().toISOString() : usuario.ultimo_acceso
            });
            
            if (result.isOk) {
              showMessage(`Usuario ${action === 'activar' ? 'activado' : 'suspendido'} correctamente`);
            } else {
              showMessage('Error al cambiar el estado del usuario');
            }
            showLoading(false);
          }
        );
      }
    }

    function deleteUser(userId) {
      const usuario = allUsuarios.find(u => u.__backendId === userId);
      if (usuario) {
        showConfirmModal(
          `¬øEst√° seguro de eliminar al usuario ${usuario.nombre_completo}? Esta acci√≥n no se puede deshacer.`,
          async () => {
            showLoading(true);
            const result = await window.dataSdk.delete(usuario);
            
            if (result.isOk) {
              showMessage('Usuario eliminado correctamente');
            } else {
              showMessage('Error al eliminar el usuario');
            }
            showLoading(false);
          }
        );
      }
    }

    function showConfirmModal(message, action) {
      document.getElementById('confirm-message').textContent = message;
      document.getElementById('confirm-modal').style.display = 'flex';
      pendingAction = action;
    }

    function closeConfirmModal() {
      document.getElementById('confirm-modal').style.display = 'none';
      pendingAction = null;
    }

    function executeAction() {
      if (pendingAction) {
        pendingAction();
        closeConfirmModal();
      }
    }

    function showLoading(show) {
      const loading = document.getElementById('loading');
      if (show) {
        loading.classList.add('active');
      } else {
        loading.classList.remove('active');
      }
    }

    function showMessage(message) {
      const messageDiv = document.createElement('div');
      messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #2e7d32;
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 2000;
        font-size: 14px;
        max-width: 300px;
      `;
      messageDiv.textContent = message;
      document.body.appendChild(messageDiv);
      
      setTimeout(() => {
        messageDiv.remove();
      }, 4000);
    }

    initializeApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'996b31a0a3726dfb',t:'MTc2MTgzMDI1Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>